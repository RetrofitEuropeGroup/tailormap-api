<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang=""><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SimpleWFSHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Aggregate Test Coverage</a> &gt; <a href="index.source.html" class="el_package">nl.b3p.tailormap.api.geotools.wfs</a> &gt; <span class="el_source">SimpleWFSHelper.java</span></div><h1>SimpleWFSHelper.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2023 B3Partners B.V.
 *
 * SPDX-License-Identifier: MIT
 */
package nl.b3p.tailormap.api.geotools.wfs;

import static nl.b3p.tailormap.api.util.HttpProxyUtil.setHttpBasicAuthenticationHeader;

import java.io.IOException;
import java.io.InputStream;
import java.lang.invoke.MethodHandles;
import java.net.URI;
import java.net.URL;
import java.net.URLEncoder;
import java.net.http.HttpClient;
import java.net.http.HttpRequest;
import java.net.http.HttpResponse;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import javax.xml.XMLConstants;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathFactory;
import org.geotools.http.HTTPClient;
import org.geotools.http.SimpleHttpClient;
import org.geotools.ows.ServiceException;
import org.geotools.ows.wms.LayerDescription;
import org.geotools.ows.wms.WMS1_1_1;
import org.geotools.ows.wms.WebMapServer;
import org.geotools.ows.wms.request.DescribeLayerRequest;
import org.geotools.ows.wms.response.DescribeLayerResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.util.xml.DomUtils;
import org.springframework.util.xml.SimpleNamespaceContext;
import org.springframework.web.util.UriComponentsBuilder;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;

/**
 * Lightweight WFS client helper with a fault-tolerant 'be liberal in what you accept' design - no
 * complete WFS XML mapping for capabilities and XML feature type schemas such as the heavyweight
 * GeoTools WFS DataStore.
 */
<span class="nc" id="L56">public class SimpleWFSHelper {</span>
<span class="nc" id="L57">  private static final Logger logger =</span>
<span class="nc" id="L58">      LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
  public static final int TIMEOUT = 5000;

  private static HttpClient getDefaultHttpClient() {
<span class="nc" id="L62">    return HttpClient.newBuilder().followRedirects(HttpClient.Redirect.NORMAL).build();</span>
  }

  public static URI getWFSRequestURL(String wfsUrl, String request) {
<span class="nc" id="L66">    return getWFSRequestURL(wfsUrl, request, null);</span>
  }

  public static URI getWFSRequestURL(
      String wfsUrl, String request, MultiValueMap&lt;String, String&gt; parameters) {
<span class="nc" id="L71">    return getWFSRequestURL(wfsUrl, request, &quot;1.1.0&quot;, parameters);</span>
  }

  public static URI getWFSRequestURL(
      String wfsUrl, String request, String version, MultiValueMap&lt;String, String&gt; parameters) {
<span class="nc" id="L76">    return getOGCRequestURL(wfsUrl, &quot;WFS&quot;, version, request, parameters);</span>
  }

  public static URI getOGCRequestURL(
      String url,
      String service,
      String version,
      String request,
      MultiValueMap&lt;String, String&gt; parameters) {

<span class="nc" id="L86">    final MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;();</span>
<span class="nc" id="L87">    params.add(&quot;SERVICE&quot;, service);</span>
<span class="nc" id="L88">    params.add(&quot;VERSION&quot;, version);</span>
<span class="nc" id="L89">    params.add(&quot;REQUEST&quot;, request);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">    if (parameters != null) {</span>
      // We need to encode the parameters manually because UriComponentsBuilder annoyingly does not
      // encode '+' as used in mime types for output formats, see
      // https://stackoverflow.com/questions/18138011
<span class="nc" id="L94">      parameters.replaceAll(</span>
          (key, values) -&gt;
<span class="nc" id="L96">              values.stream()</span>
<span class="nc" id="L97">                  .map(s -&gt; URLEncoder.encode(s, StandardCharsets.UTF_8))</span>
<span class="nc" id="L98">                  .collect(Collectors.toList()));</span>
<span class="nc" id="L99">      params.addAll(parameters);</span>
    }
<span class="nc" id="L101">    return UriComponentsBuilder.fromHttpUrl(url).replaceQueryParams(params).build(true).toUri();</span>
  }

  /**
   * Just get the list of supported output formats for the typename. If there are no specific output
   * formats for the type, the generally supported output formats are returned. Requests WFS 1.1.0
   * but also handles WFS 2.0.0 responses.
   */
  public static List&lt;String&gt; getOutputFormats(
      String wfsUrl, String typeName, String username, String password) throws Exception {
<span class="nc" id="L111">    return getOutputFormats(wfsUrl, typeName, username, password, getDefaultHttpClient());</span>
  }

  public static List&lt;String&gt; getOutputFormats(
      String wfsUrl, String typeName, String username, String password, HttpClient httpClient)
      throws Exception {

<span class="nc" id="L118">    URI wfsGetCapabilities = getWFSRequestURL(wfsUrl, &quot;GetCapabilities&quot;);</span>

<span class="nc" id="L120">    HttpRequest.Builder requestBuilder = HttpRequest.newBuilder().uri(wfsGetCapabilities);</span>

<span class="nc" id="L122">    setHttpBasicAuthenticationHeader(requestBuilder, username, password);</span>

<span class="nc" id="L124">    HttpResponse&lt;InputStream&gt; response =</span>
<span class="nc" id="L125">        httpClient.send(requestBuilder.build(), HttpResponse.BodyHandlers.ofInputStream());</span>

    // Parse capabilities in DOM

<span class="nc" id="L129">    DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L130">    documentBuilderFactory.setNamespaceAware(true);</span>
<span class="nc" id="L131">    documentBuilderFactory.setExpandEntityReferences(false);</span>
<span class="nc" id="L132">    documentBuilderFactory.setValidating(false);</span>
<span class="nc" id="L133">    documentBuilderFactory.setXIncludeAware(false);</span>
<span class="nc" id="L134">    documentBuilderFactory.setCoalescing(true);</span>
<span class="nc" id="L135">    documentBuilderFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);</span>
<span class="nc" id="L136">    DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();</span>
<span class="nc" id="L137">    Document doc = documentBuilder.parse(response.body());</span>

    // WFS 1.1.0 and WFS 2.0.0 use different namespaces, but the same local element names
<span class="nc" id="L140">    boolean wfs2 = &quot;2.0.0&quot;.equals(doc.getDocumentElement().getAttribute(&quot;version&quot;));</span>
<span class="nc" id="L141">    XPath xPath = XPathFactory.newInstance().newXPath();</span>
<span class="nc" id="L142">    SimpleNamespaceContext namespaceContext = new SimpleNamespaceContext();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">    namespaceContext.bindNamespaceUri(&quot;ows&quot;, &quot;http://www.opengis.net/ows&quot; + (wfs2 ? &quot;/1.1&quot; : &quot;&quot;));</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">    namespaceContext.bindNamespaceUri(&quot;wfs&quot;, &quot;http://www.opengis.net/wfs&quot; + (wfs2 ? &quot;/2.0&quot; : &quot;&quot;));</span>
<span class="nc" id="L145">    xPath.setNamespaceContext(namespaceContext);</span>

<span class="nc" id="L147">    List&lt;String&gt; outputFormats = null;</span>

    // Find all feature types and loop through to find the typeName. We can't use XPath with the
    // typeName parameter in it to find the exact FeatureType because escaping characters like '
    // in the typeName is not possible.
<span class="nc" id="L152">    NodeList featureTypes =</span>
        (NodeList)
            xPath
<span class="nc" id="L155">                .compile(&quot;/wfs:WFS_Capabilities&quot; + &quot;/wfs:FeatureTypeList&quot; + &quot;/wfs:FeatureType&quot;)</span>
<span class="nc" id="L156">                .evaluate(doc, XPathConstants.NODESET);</span>

<span class="nc bnc" id="L158" title="All 2 branches missed.">    for (int i = 0; i &lt; featureTypes.getLength(); i++) {</span>
<span class="nc" id="L159">      Element n = (Element) featureTypes.item(i);</span>
<span class="nc" id="L160">      Element name = DomUtils.getChildElementByTagName(n, &quot;Name&quot;);</span>
<span class="nc bnc" id="L161" title="All 4 branches missed.">      if (name != null &amp;&amp; typeName.equals(DomUtils.getTextValue(name))) {</span>
<span class="nc" id="L162">        Element formatsNode = DomUtils.getChildElementByTagName(n, &quot;OutputFormats&quot;);</span>
<span class="nc bnc" id="L163" title="All 2 branches missed.">        if (formatsNode != null) {</span>
<span class="nc" id="L164">          outputFormats =</span>
<span class="nc" id="L165">              DomUtils.getChildElementsByTagName(formatsNode, &quot;Format&quot;).stream()</span>
<span class="nc" id="L166">                  .map(DomUtils::getTextValue)</span>
<span class="nc" id="L167">                  .collect(Collectors.toList());</span>
        }
        break;
      }
    }

    // No output formats found (or maybe not even the featureType...), return output formats from
    // OperationsMetadata
<span class="nc bnc" id="L175" title="All 2 branches missed.">    if (outputFormats == null) {</span>
<span class="nc" id="L176">      String xpathExpr =</span>
          &quot;/wfs:WFS_Capabilities&quot;
              + &quot;/ows:OperationsMetadata&quot;
              + &quot;/ows:Operation[@name='GetFeature']&quot;
              + &quot;/ows:Parameter[@name='outputFormat']&quot;
              + &quot;//ows:Value&quot;;
<span class="nc" id="L182">      NodeList nodes = (NodeList) xPath.compile(xpathExpr).evaluate(doc, XPathConstants.NODESET);</span>

<span class="nc" id="L184">      outputFormats = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">      for (int i = 0; i &lt; nodes.getLength(); i++) {</span>
<span class="nc" id="L186">        outputFormats.add(DomUtils.getTextValue((Element) nodes.item(i)));</span>
      }
    }

<span class="nc" id="L190">    return outputFormats;</span>
  }

  public static WebMapServer getWebMapServer(String url, String username, String password)
      throws IOException, ServiceException {
<span class="nc" id="L195">    HTTPClient client = new SimpleHttpClient();</span>
<span class="nc" id="L196">    client.setUser(username);</span>
<span class="nc" id="L197">    client.setPassword(password);</span>
<span class="nc" id="L198">    client.setConnectTimeout(TIMEOUT);</span>
<span class="nc" id="L199">    client.setReadTimeout(TIMEOUT);</span>
<span class="nc" id="L200">    return new WebMapServer(new URL(url), client);</span>
  }

  public static SimpleWFSLayerDescription describeWMSLayer(
      String url, String username, String password, String layerName) {
<span class="nc" id="L205">    return describeWMSLayers(url, username, password, List.of(layerName)).get(layerName);</span>
  }

  public static Map&lt;String, SimpleWFSLayerDescription&gt; describeWMSLayers(
      String url, String username, String password, List&lt;String&gt; layers) {
    try {
<span class="nc" id="L211">      WebMapServer wms = getWebMapServer(url, username, password);</span>
      // Directly create WMS 1.1.1 request. Creating it from WebMapServer errors with GeoServer
      // about unsupported request in capabilities unless we override WebMapServer to set up
      // specifications.
<span class="nc" id="L215">      DescribeLayerRequest describeLayerRequest =</span>
<span class="nc" id="L216">          new WMS1_1_1().createDescribeLayerRequest(new URL(url));</span>
<span class="nc" id="L217">      describeLayerRequest.setProperty(</span>
          &quot;VERSION&quot;, &quot;1.1.1&quot;); // Otherwise GeoTools will send VERSION=1.1.0...
<span class="nc" id="L219">      describeLayerRequest.setLayers(String.join(&quot;,&quot;, layers));</span>
      // GeoTools will throw a ClassCastException when a WMS ServiceException is returned
<span class="nc" id="L221">      DescribeLayerResponse describeLayerResponse = wms.issueRequest(describeLayerRequest);</span>

<span class="nc" id="L223">      Map&lt;String, SimpleWFSLayerDescription&gt; descriptions = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">      for (LayerDescription ld : describeLayerResponse.getLayerDescs()) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        String wfsUrl = ld.getWfs() != null ? ld.getWfs().toString() : null;</span>
<span class="nc bnc" id="L226" title="All 4 branches missed.">        if (wfsUrl == null &amp;&amp; &quot;WFS&quot;.equalsIgnoreCase(ld.getOwsType())) {</span>
<span class="nc" id="L227">          wfsUrl = ld.getOwsURL().toString();</span>
        }
        // OGC 02-070 Annex B says the wfs/owsURL attributed are not required but implied. Some
        // Deegree instance encountered has all attributes empty, and apparently the meaning is that
        // the WFS URL is the same as the WMS URL (not explicitly defined in the spec).
<span class="nc bnc" id="L232" title="All 2 branches missed.">        if (wfsUrl == null) {</span>
<span class="nc" id="L233">          wfsUrl = wms.getInfo().getSource().toString();</span>
        }

<span class="nc bnc" id="L236" title="All 6 branches missed.">        if (wfsUrl != null &amp;&amp; ld.getQueries() != null &amp;&amp; ld.getQueries().length != 0) {</span>
<span class="nc" id="L237">          descriptions.put(ld.getName(), new SimpleWFSLayerDescription(wfsUrl, ld.getQueries()));</span>
        }
      }
<span class="nc" id="L240">      return Collections.unmodifiableMap(descriptions);</span>
<span class="nc" id="L241">    } catch (Exception e) {</span>
<span class="nc" id="L242">      String msg =</span>
<span class="nc" id="L243">          String.format(</span>
              &quot;Error in DescribeLayer request to WMS \&quot;%s\&quot;: %s: %s&quot;,
<span class="nc" id="L245">              url, e.getClass(), e.getMessage());</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">      if (logger.isTraceEnabled()) {</span>
<span class="nc" id="L247">        logger.trace(msg, e);</span>
      } else {
<span class="nc" id="L249">        logger.debug(msg + &quot;. Set log level to TRACE for stacktrace.&quot;);</span>
      }
    }

<span class="nc" id="L253">    return Collections.emptyMap();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>